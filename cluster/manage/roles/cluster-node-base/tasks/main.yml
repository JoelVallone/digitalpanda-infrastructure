---
# This role sets up a user for the cluster configuration and sets up the ssh accesses
 
- name: "Create {{ cluster_config_user }} user"
  become: yes
  user:
    name: "{{ cluster_config_user }}"
    comment: "Cluster configuration account"
    generate_ssh_key: yes

- name: "Check if pasword-less sudo for user {{ cluster_config_user }} is set"
  become: yes
  shell: grep "{{ cluster_config_user }} ALL=(ALL) NOPASSWD:ALL" /etc/sudoers || true
  register: pasword_less_user

- name: "Enable pasword-less sudo for user {{ cluster_config_user }}"
  become: yes
  lineinfile: dest=/etc/sudoers
              line="{{ cluster_config_user }} ALL=(ALL) NOPASSWD:ALL"
  when: pasword_less_user != ""

- name: "Register ssh autorized_keys into {{ cluster_config_user }}"
  become: yes
  authorized_key:
    user: "{{ cluster_config_user }}"
    state: present
    key: '{{ item }}'
  with_lines: cat '{{ role_path }}/files/authorized_keys'


#^127\.0\.1\.1(( |\t)*)((?!\b\.digitalpanda\.org\b).)*$
- name: "Check domain name {{ cluster_config_domain_name }} present"
  become: yes
  replace: dest=/etc/hosts
           regexp='^(127\.0\.1\.1(( |\t)+)((?!\b\.{{ cluster_config_domain_name }}\b).)+)$'
           replace='\1 {{ ansible_hostname }}.{{ cluster_config_domain_name }}'
  when: false